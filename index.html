<!DOCTYPE html>
<html>
<head>
    <title>STAC TRACE - SURVEILLANCE HOTSPOTS</title>
    <meta charset="utf-8">
    <script src='https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
        }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #ffffff;
            padding: 8px;
            border: 1px solid #ffffff;
            font-size: 12px;
            width: 140px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-panel h3 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #ffffff;
            text-transform: uppercase;
        }

        #image-info {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ffffff;
            font-size: 11px;
        }
        .info-panel p {
            margin: 4px 0;
            font-size: 10px;
        }
        .info-panel strong {
            color: #ffffff;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 8px;
            border: 1px solid #00ff00;
            font-size: 11px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #00ff00;
        }
        .hotspot-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff0000, #880000);
            border: 1px solid #ffffff;
            cursor: pointer;
        }
        .legend div {
            margin: 2px 0;
        }
        .legend .color-box {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin-right: 6px;
            border: 1px solid #ffffff;
        }


    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h3>STAC TRACE</h3>
        <p><strong>DATES:</strong> <span id="date-range">-</span></p>
        <p><strong>IMAGES:</strong> <span id="total-images">0</span></p>
        <p><strong>HOTSPOTS:</strong> <span id="total-hotspots">0</span></p>
        <div id="image-info"><!-- Satellite info appears here on hover --></div>
    </div>


    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            const map = new maplibregl.Map({
                container: 'map',
                attributionControl: false,
                style: {
                    version: 8,
                    projection: {
                        type: 'globe'
                    },
                    sources: {
                        'satellite': {
                            type: 'raster',
                            tiles: [
                                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                            ],
                            tileSize: 256,
                            attribution: '© Esri'
                        }
                    },
                    layers: [
                        {
                            id: 'background',
                            type: 'background',
                            paint: {
                                'background-color': '#000000'
                            }
                        },
                        {
                            id: 'satellite-layer',
                            type: 'raster',
                            source: 'satellite',
                            paint: {
                                'raster-saturation': -1
                            }
                        }
                    ]
                },
                center: [0, 20],
                zoom: 1.5,
                maxZoom: 18
            });

        let hotspotsData = null;
        let totalImages = 0;
        let totalHotspots = 0;

        // Wait for map to load before adding data
        map.on('load', () => {
            console.log('> LOADING SATELLITE DATA...');

            // Load both raw data and hotspots in parallel
            Promise.all([
                fetch('data/stac_data.json').then(r => r.json()).catch(() => ({ features: [] })),
                fetch('data/hotspots.geojson').then(r => r.json()).catch(() => ({ features: [] }))
            ]).then(([rawData, hotspotsGeoJson]) => {
                // Filter for high-resolution satellites only (<=75cm and not SPOT)
                const filteredData = {
                    type: "FeatureCollection",
                    features: (rawData.features || []).filter(feature => {
                        const props = feature.properties;
                        const constellation = props.constellation?.toLowerCase();
                        const resolution = props.resolution;
                        return constellation !== 'spot' && resolution <= 0.75;
                    })
                };

                hotspotsData = filteredData;
                totalImages = filteredData.features.length;
                totalHotspots = (hotspotsGeoJson.features || []).length;

                // Calculate date range
                const dates = filteredData.features
                    .map(f => new Date(f.properties.datetime))
                    .filter(d => !isNaN(d));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                const formatDate = d => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

                // Update info panel
                document.getElementById('date-range').textContent = `${formatDate(minDate)} – ${formatDate(maxDate)}`;
                document.getElementById('total-images').textContent = totalImages;
                document.getElementById('total-hotspots').textContent = totalHotspots;

                console.log(`> LOADED ${totalImages} RAW SATELLITE IMAGES`);
                console.log(`> LOADED ${totalHotspots} HOTSPOT CLUSTERS`);

                // Add data to map
                addDataToMap(filteredData, hotspotsGeoJson);
            }).catch(error => {
                console.error('> ERROR LOADING DATA:', error);
                document.querySelector('.info-panel').innerHTML = '<h3>ERROR</h3><p>FAILED TO LOAD DATA</p>';
            });
        });

        function addDataToMap(data, hotspots) {
            // Add satellite image footprints
            map.addSource('satellite-images', {
                type: 'geojson',
                data: data
            });

            // Add fill layer for individual images
            map.addLayer({
                id: 'satellite-footprints',
                type: 'fill',
                source: 'satellite-images',
                paint: {
                    'fill-color': 'rgba(0, 0, 0, 0.15)',
                    'fill-opacity': 1.0,
                    'fill-outline-color': '#ffffff'
                }
            });

            // Add outline layer for individual images
            map.addLayer({
                id: 'satellite-outlines',
                type: 'line',
                source: 'satellite-images',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1,
                    'line-opacity': 0.8
                }
            });

            // Add hotspot clusters if available
            if (hotspots && hotspots.features && hotspots.features.length > 0) {
                map.addSource('hotspots', {
                    type: 'geojson',
                    data: hotspots
                });

                // Add hotspot fill layer (red highlight)
                map.addLayer({
                    id: 'hotspot-fill',
                    type: 'fill',
                    source: 'hotspots',
                    paint: {
                        'fill-color': '#ff0000',
                        'fill-opacity': 0.25
                    }
                });

                // Add hotspot outline
                map.addLayer({
                    id: 'hotspot-outline',
                    type: 'line',
                    source: 'hotspots',
                    paint: {
                        'line-color': '#ff0000',
                        'line-width': 2,
                        'line-opacity': 0.9
                    }
                });

                // Hotspot hover interaction
                map.on('mouseenter', 'hotspot-fill', (e) => {
                    const feature = e.features[0];
                    const props = feature.properties;
                    const imageCount = props.hotspot_image_count || 0;
                    const latest = props.latest_datetime ? new Date(props.latest_datetime).toLocaleDateString() : 'Unknown';
                    const collection = props.primary_collection || 'Mixed';
                    const location = props.location_name || `${props.hotspot_centroid_lat?.toFixed(3)}, ${props.hotspot_centroid_lon?.toFixed(3)}`;

                    document.getElementById('image-info').innerHTML = `
                        <strong style="color: #ff0000">HOTSPOT</strong><br>
                        <strong>${location}</strong><br>
                        ${imageCount} images<br>
                        Latest: ${latest}<br>
                        Primary: ${collection}
                    `;
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', 'hotspot-fill', () => {
                    document.getElementById('image-info').innerHTML = '';
                    map.getCanvas().style.cursor = '';
                });

                // Click to open Google Earth
                map.on('click', 'hotspot-fill', (e) => {
                    const feature = e.features[0];
                    const props = feature.properties;
                    const lat = props.hotspot_centroid_lat;
                    const lon = props.hotspot_centroid_lon;
                    if (lat && lon) {
                        const earthUrl = `https://earth.google.com/web/@${lat},${lon},0a,50000d,35y,0h,0t,0r`;
                        window.open(earthUrl, '_blank');
                    }
                });
            }

            // Update info panel on hover for raw images
            map.on('mouseenter', 'satellite-footprints', (e) => {
                const feature = e.features[0];
                const props = feature.properties;

                document.getElementById('image-info').innerHTML = `
                    <strong>${props.constellation?.toUpperCase()}</strong><br>
                    ${new Date(props.datetime).toLocaleString()}<br>
                    ${props.resolution}m resolution
                `;
            });

            map.on('mouseleave', 'satellite-footprints', () => {
                document.getElementById('image-info').innerHTML = '';
            });

            // Change cursor on hover
            map.on('mouseenter', 'satellite-footprints', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'satellite-footprints', () => {
                map.getCanvas().style.cursor = '';
            });

            // Fit bounds to show all data (prioritize hotspots if available)
            const bounds = new maplibregl.LngLatBounds();
            const dataToFit = (hotspots && hotspots.features && hotspots.features.length > 0) ? hotspots : data;

            dataToFit.features.forEach(feature => {
                if (feature.geometry && feature.geometry.type === 'Polygon') {
                    feature.geometry.coordinates[0].forEach(coord => {
                        bounds.extend(coord);
                    });
                } else if (feature.geometry && feature.geometry.type === 'MultiPolygon') {
                    feature.geometry.coordinates.forEach(polygon => {
                        polygon[0].forEach(coord => {
                            bounds.extend(coord);
                        });
                    });
                }
            });

            // Only fit bounds if we have coordinates
            try {
                const boundsArray = bounds.toArray();
                if (boundsArray && boundsArray.length === 2 &&
                    boundsArray[0].length === 2 && boundsArray[1].length === 2) {
                    map.fitBounds(bounds, { padding: 50 });
                    console.log('> MAP BOUNDS FITTED');
                } else {
                    console.log('> NO VALID BOUNDS, USING DEFAULT VIEW');
                }
            } catch (error) {
                console.log('> COULD NOT FIT BOUNDS:', error.message);
            }
        }

            // Add navigation controls
            map.addControl(new maplibregl.NavigationControl());
        });
    </script>
</body>
</html>