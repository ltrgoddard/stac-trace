<!DOCTYPE html>
<html>
<head>
    <title>STAC TRACE - SURVEILLANCE HOTSPOTS</title>
    <meta charset="utf-8">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
        }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 8px;
            border: 1px solid #00ff00;
            font-size: 11px;
            max-width: 280px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-panel h3 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #00ff00;
            text-transform: uppercase;
        }
        .info-panel p {
            margin: 4px 0;
            font-size: 10px;
        }
        .info-panel strong {
            color: #ffffff;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 8px;
            border: 1px solid #00ff00;
            font-size: 11px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #00ff00;
        }
        .hotspot-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff0000, #880000);
            border: 1px solid #ffffff;
            cursor: pointer;
        }
        .legend div {
            margin: 2px 0;
        }
        .legend .color-box {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin-right: 6px;
            border: 1px solid #ffffff;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h3>STAC HOTSPOTS</h3>
        <p><strong>ENGINE:</strong> MAPBOX GL JS</p>
        <p><strong>PROJECTION:</strong> GLOBE</p>
        <p><strong>CLUSTERING:</strong> INTERSECTION</p>
        <p><strong>CLUSTERS:</strong> <span id="total-hotspots">0</span></p>
        <p><strong>IMAGES:</strong> <span id="total-images">0</span></p>
        <p><strong>RANGE:</strong> LAST 7 DAYS</p>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #00ff00; font-size: 10px;">
            CLICK CLUSTERS FOR DETAILS
        </div>
    </div>
    </div>


    <script>
        // Set Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGF0YS1kZXNrIiwiYSI6ImNsYmNlcjl4bjBjd3UzcG55dHluaHYzbmQifQ.2wVVsUzF2BHBJ9ywCxCqWw';

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map with Mapbox GL JS and globe projection
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-v9', // Satellite style for better globe visibility
                center: [0, 20], // Center on equator
                zoom: 1.5,
                maxZoom: 18,
                projection: 'globe', // Globe projection
                // Disable all map controls for clean interface
                attributionControl: false,
                interactive: true, // Keep interactivity for popups
                pitchWithRotate: false,
                dragRotate: false,
                touchZoomRotate: false
            });

            // Remove any default controls that might be added
            map.on('load', () => {
                // Remove navigation control if it exists
                const navControl = map._controls.find(control => control instanceof mapboxgl.NavigationControl);
                if (navControl) {
                    map.removeControl(navControl);
                }
            });

            console.log('> STAC TRACE - GLOBE PROJECTION INITIALIZED');

            // Enhanced error handling
            map.on('error', (e) => {
                console.log('> MAP ERROR:', e.error.message);
                if (e.error.message.includes('projection') || e.error.message.includes('WebGL') || e.error.message.includes('globe')) {
                    console.log('> FORCING GLOBE PROJECTION...');
                    setTimeout(() => {
                        try {
                            map.setProjection('globe');
                            console.log('> GLOBE PROJECTION SUCCESS');
                        } catch (retryError) {
                            console.log('> GLOBE PROJECTION FAILED:', retryError.message);
                            console.log('> FALLBACK TO MERCATOR');
                            try {
                                map.setProjection('mercator');
                            } catch (fallbackError) {
                                console.log('> FALLBACK FAILED');
                            }
                        }
                    }, 1000);
                }
            });

        let hotspotsData = null;
        let totalImages = 0;
        let totalHotspots = 0;

        // Wait for map to load before adding data
        map.on('load', () => {
            console.log('> LOADING SATELLITE DATA...');

            // Load GeoJSON data
            fetch('data/hotspots.geojson')
                .then(response => response.json())
                .then(data => {
                    hotspotsData = data;
                    totalHotspots = data.features.length; // Number of merged clusters

                    // Sum up all images across clusters
                    totalImages = data.features.reduce((sum, feature) => {
                        return sum + (feature.properties.hotspot_image_count || 0);
                    }, 0);

                    // Update info panel
                    document.getElementById('total-images').textContent = totalImages;
                    document.getElementById('total-hotspots').textContent = totalHotspots;

                    console.log(`> LOADED ${totalHotspots} CLUSTERS WITH ${totalImages} IMAGES`);
                    console.log('> EACH CLUSTER = MERGED INTERSECTING IMAGES');

                    // Add data to map
                    addDataToMap(data);
                })
                .catch(error => {
                    console.error('> ERROR LOADING DATA:', error);
                    document.querySelector('.info-panel').innerHTML = '<h3>ERROR</h3><p>FAILED TO LOAD HOTSPOTS</p>';
                });
        });

        function addDataToMap(data) {
            // Add satellite image footprints
            map.addSource('satellite-images', {
                type: 'geojson',
                data: data
            });

            // Add fill layer for merged clusters
            map.addLayer({
                id: 'satellite-footprints',
                type: 'fill',
                source: 'satellite-images',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'hotspot_image_count'],
                        5, '#ffe6e6',   // Light red for small clusters
                        10, '#ff9999', // Medium red for medium clusters
                        15, '#ff6b6b', // Default red for larger clusters
                        25, '#ff3333'  // Dark red for large clusters
                    ],
                    'fill-opacity': 0.6,
                    'fill-outline-color': '#ffffff'
                }
            });

            // Add outline layer for merged clusters
            map.addLayer({
                id: 'satellite-outlines',
                type: 'line',
                source: 'satellite-images',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 2,
                    'line-opacity': 1.0
                }
            });

            // Add cluster size labels
            map.addLayer({
                id: 'cluster-labels',
                type: 'symbol',
                source: 'satellite-images',
                layout: {
                    'text-field': ['get', 'hotspot_image_count'],
                    'text-size': 12,
                    'text-anchor': 'center',
                    'text-justify': 'center'
                },
                paint: {
                    'text-color': '#ffffff',
                    'text-halo-color': '#000000',
                    'text-halo-width': 2
                }
            });







            // Fit bounds to show all data
            const bounds = new mapboxgl.LngLatBounds();
            data.features.forEach(feature => {
                if (feature.geometry.type === 'Polygon') {
                    // Handle single merged Polygon
                    feature.geometry.coordinates[0].forEach(coord => {
                        bounds.extend(coord);
                    });
                }
            });

            // Only fit bounds if we have coordinates
            try {
                // Check if bounds has been extended (has valid coordinates)
                const boundsArray = bounds.toArray();
                if (boundsArray && boundsArray.length === 2 &&
                    boundsArray[0].length === 2 && boundsArray[1].length === 2) {
                    map.fitBounds(bounds, { padding: 20 });
                    console.log('> MAP BOUNDS FITTED TO CLUSTERS');
                } else {
                    console.log('> NO VALID BOUNDS, USING DEFAULT VIEW');
                }
            } catch (error) {
                console.log('> COULD NOT FIT BOUNDS:', error.message);
            }
        }

            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.FullscreenControl());

            // Enable globe rotation controls
            map.on('load', () => {
                console.log('üåç Mapbox Globe Projection Active');
                console.log('üñ±Ô∏è Right-click and drag to rotate the globe');
                console.log('üîç Scroll to zoom, click satellite images for details');
            });
        });
    </script>
</body>
</html>